{% extends "base.html" %}

{% block title %}Notificações - Praias Fluviais{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="bg-white/60 backdrop-blur-md shadow-xl rounded-2xl border border-gray-100 overflow-hidden">
    <div class="p-6">
      <h1 class="text-2xl font-bold text-gray-900 flex items-center mb-4"><i class="fas fa-bell text-primary-500 mr-3"></i>Notificações</h1>

      {% if notifications and notifications|length > 0 %}
      <div class="space-y-4">
        {% for notif in notifications %}
        <div class="flex items-start space-x-4 p-4 rounded-xl bg-white" data-notification-id="{{ notif.id }}">
          <div class="flex-shrink-0">
            <div class="h-8 w-8 rounded-full flex items-center justify-center
                {% if notif.type == 'success' %}
                    bg-green-100 text-green-600
                {% elif notif.type == 'warning' %}
                    bg-yellow-100 text-yellow-600
                {% elif notif.type == 'error' %}
                    bg-red-100 text-red-600
                {% else %}
                    bg-primary-100 text-primary-600
                {% endif %}">
              <i class="fas {% if notif.type == 'success' %}fa-check{% elif notif.type == 'warning' %}fa-exclamation{% elif notif.type == 'error' %}fa-times{% else %}fa-info{% endif %}"></i>
            </div>
          </div>
          <div class="flex-1">
            <h4 class="text-sm font-medium text-gray-900">{{ notif.title }}</h4>
            <p class="text-sm text-gray-500">{{ notif.message }}</p>
            <div class="mt-2 flex items-center space-x-4">
              <span class="text-xs text-gray-400">{{ notif.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
              {% if notif.link %}
              <a href="{{ notif.link }}" data-notification-id="{{ notif.id }}" class="notif-open-link text-xs text-primary-600 hover:text-primary-700">Ver mais</a>
              {% endif %}
              <button data-notification-id="{{ notif.id }}" class="mark-as-read-btn text-xs text-gray-500 hover:text-gray-700">Marcar como lida</button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-8 text-gray-500">
        <i class="fas fa-info-circle text-2xl mb-2"></i>
        <div>Nenhuma notificação encontrada.</div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
// Reuso da função markAsRead presente em profile.html
function markAsRead(notificationId) {
  // Return a promise so callers can wait before navigating
  return fetch(`/notifications/${notificationId}/mark-as-read`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  }).then(response => {
    if (response.ok) {
      const notification = document.querySelector(`[data-notification-id="${notificationId}"]`);
      if (notification) {
        notification.style.transition = 'all 0.3s ease-out';
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(10px)';
        setTimeout(() => notification.remove(), 300);
      }
      return true;
    } else {
      console.error('Erro ao marcar notificação como lida', response.statusText);
      return false;
    }
  }).catch(err => {
    console.error('Erro ao marcar notificação como lida', err);
    return false;
  });
}

document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.mark-as-read-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.notificationId;
      markAsRead(id);
    });
  });

    // Quando o utilizador clica em "Ver mais", marca a notificação como lida antes de navegar
    document.querySelectorAll('.notif-open-link').forEach(link => {
      link.addEventListener('click', function(ev) {
        // permite fallback se JS estiver desactivado
        ev.preventDefault();
        const id = this.dataset.notificationId;
        const href = this.href;
        if (!id) {
          // sem id, navega normalmente
          window.location.href = href;
          return;
        }

        // Marca como lida, depois navega (mesmo que a marca falhe, navega na mesma)
        markAsRead(id).finally(() => {
          window.location.href = href;
        });
      });
    });
});
</script>
{% endblock %}
