<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}Praias Fluviais{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tweaks.css') }}">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            }
          }
        }
      }
    }
  </script>
  <!-- Head no longer binds mobile menu to avoid duplicate handlers; binding happens in the footer script -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-primary-50">
  <!-- Navbar -->
  <nav class="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex justify-between h-16">
        <div class="flex">
          <div class="flex-shrink-0 flex items-center">
            <span class="text-primary-600 text-xl font-bold tracking-tight">
              <i class="fas fa-water mr-2"></i>Praias Fluviais
            </span>
          </div>
        </div>
        
  {% if current_user.is_authenticated and session.get('reauthenticated') and request.endpoint not in ['login', 'index'] %}
        <div class="flex">
          <div class="hidden sm:ml-6 sm:flex sm:space-x-1">
            <a href="{{ url_for('dashboard') }}" class="text-gray-600 hover:text-primary-600 hover:bg-primary-50 inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200">
              <i class="fas fa-home mr-2"></i> Dashboard
            </a>
            <a href="{{ url_for('ocorrencias') }}" class="text-gray-600 hover:text-primary-600 hover:bg-primary-50 inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200">
              <i class="fas fa-clipboard-list mr-2"></i> Ocorrências
            </a>
            {% if current_user.role == 'presidente' or current_user.role == 'supervisor' %}
            <a href="{{ url_for('users') }}" class="text-gray-600 hover:text-primary-600 hover:bg-primary-50 inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200">
              <i class="fas fa-users mr-2"></i> Utilizadores
            </a>
            {% endif %}
            <div class="group inline-flex items-center">
              <a href="#" class="text-gray-600 hover:text-primary-600 hover:bg-primary-50 inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200">
                <i class="fas fa-download mr-2"></i> Exportar
              </a>
              <div class="absolute hidden group-hover:block pt-7 z-50" style="margin-top: 0.5rem;">
                <div class="bg-white rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 py-2">
                  <button type="button" data-export-url="{{ url_for('export_csv') }}" data-export-type="csv" class="global-export-btn block text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-600">
                    <i class="fas fa-file-csv mr-2"></i> Exportar CSV
                  </button>
                  <button type="button" data-export-url="{{ url_for('export_pdf') }}" data-export-type="pdf" class="global-export-btn block text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-600">
                    <i class="fas fa-file-pdf mr-2"></i> Exportar PDF
                  </button>
                </div>
              </div>
            </div>
            <!-- Profile Menu -->
            <div class="relative ml-4 flex items-center">
              <!-- Alinhamento: usar exactamente as mesmas classes dos outros itens do menu -->
              <button type="button" id="profileMenuButton" class="text-gray-600 hover:text-primary-600 hover:bg-primary-50 inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200">
                <div class="h-5 w-5 rounded-full bg-primary-100 flex items-center justify-center mr-2">
                  <i class="fas fa-user text-primary-600 text-sm"></i>
                </div>
                <span class="text-sm font-medium text-gray-700">{{ current_user.name }}</span>
                <i class="fas fa-chevron-down text-gray-400 text-sm ml-2"></i>
              </button>
              <!-- Profile Dropdown -->
              <div class="hidden absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg py-2 border border-gray-100 z-50" id="profileMenu">
                <div class="px-4 py-2 border-b border-gray-100">
                  <p class="text-sm font-medium text-gray-900">{{ current_user.name }}</p>
                  <p class="text-xs text-gray-500">{{ current_user.email }}</p>
                </div>
                <div class="py-1">
                  <!-- Informações do Usuário -->
                  <div class="px-4 py-2">
                    <p class="text-xs font-medium text-gray-500">Função</p>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium mt-1
                      {% if current_user.role == 'presidente' %}
                        bg-purple-100 text-purple-800
                      {% elif current_user.role == 'supervisor' %}
                        bg-primary-100 text-primary-800
                      {% else %}
                        bg-green-100 text-green-800
                      {% endif %}">
                      {{ current_user.role|title }}
                    </span>
                  </div>
                  
                  <!-- Menu Principal -->
                  <div class="px-2">
                    <a href="{{ url_for('edit_user', id=current_user.id) }}" class="group flex items-center px-2 py-2 text-sm text-gray-700 rounded-lg hover:bg-primary-50 hover:text-primary-600">
                      <i class="fas fa-user-circle mr-3 text-gray-400 group-hover:text-primary-600"></i>
                      Editar Perfil
                    </a>
                    
                    <a href="{{ url_for('change_password') }}" class="group flex items-center px-2 py-2 text-sm text-gray-700 rounded-lg hover:bg-primary-50 hover:text-primary-600">
                      <i class="fas fa-shield-alt mr-3 text-gray-400 group-hover:text-primary-600"></i>
                      Alterar Palavra-passe
                    </a>

                    <a href="{{ url_for('notifications') }}" class="group flex items-center px-2 py-2 text-sm text-gray-700 rounded-lg hover:bg-primary-50 hover:text-primary-600">
                      <i class="fas fa-bell mr-3 text-gray-400 group-hover:text-primary-600"></i>
                      Notificações
                      <span class="ml-auto bg-primary-100 text-primary-600 text-xs font-medium px-2 py-0.5 rounded-full">{{ unread_notification_count }}</span>
                    </a>
                  </div>
                </div>

                <!-- Configurações -->
                <div class="py-1 border-t border-gray-100">
                  <div class="px-2">
                    <a href="{{ url_for('activities') }}" class="group flex items-center px-2 py-2 text-sm text-gray-700 rounded-lg hover:bg-primary-50 hover:text-primary-600">
                      <i class="fas fa-clock mr-3 text-gray-400 group-hover:text-primary-600"></i>
                      Histórico de Atividades
                    </a>

                    <a href="{{ url_for('settings') }}" class="group flex items-center px-2 py-2 text-sm text-gray-700 rounded-lg hover:bg-primary-50 hover:text-primary-600">
                      <i class="fas fa-desktop mr-3 text-gray-400 group-hover:text-primary-600"></i>
                      Preferências de Exibição
                    </a>

                    {% if current_user.role in ['presidente', 'supervisor'] %}
                    <a href="{{ url_for('settings') }}" class="group flex items-center px-2 py-2 text-sm text-primary-700 rounded-lg hover:bg-primary-50 hover:text-primary-800 font-semibold">
                      <i class="fas fa-cogs mr-3 text-primary-400 group-hover:text-primary-800"></i>
                      Configurações
                    </a>
                    <a href="{{ url_for('export_pdf') }}" class="group flex items-center px-2 py-2 text-sm text-gray-700 rounded-lg hover:bg-primary-50 hover:text-primary-600">
                      <i class="fas fa-chart-bar mr-3 text-gray-400 group-hover:text-primary-600"></i>
                      Relatórios & Estatísticas
                    </a>
                    {% endif %}
                  </div>
                </div>

                <!-- Sair -->
                <div class="py-1 border-t border-gray-100">
                  <div class="px-2">
                    <a href="{{ url_for('logout') }}" class="group flex items-center px-2 py-2 text-sm text-red-600 rounded-lg hover:bg-red-50">
                      <i class="fas fa-sign-out-alt mr-3 text-red-400 group-hover:text-red-600"></i>
                      Terminar Sessão
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Mobile menu button -->
          <div class="flex items-center sm:hidden">
            <button id="mobileMenuButton" aria-label="Abrir menu" class="p-2 rounded-md text-gray-600 hover:text-primary-600 hover:bg-primary-50 focus:outline-none focus:ring-2 focus:ring-primary-300">
              <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
          </div>
        </div>
        {% endif %}
        
        <script>
          // Profile Menu Toggle (guarded)
          const profileMenuButton = document.getElementById('profileMenuButton');
          const profileMenu = document.getElementById('profileMenu');
          if (profileMenuButton && profileMenu) {
            profileMenuButton.addEventListener('click', () => {
              profileMenu.classList.toggle('hidden');
            });

            document.addEventListener('click', (event) => {
              if (!profileMenuButton.contains(event.target) && !profileMenu.contains(event.target)) {
                profileMenu.classList.add('hidden');
              }
            });
          }

          // Global export buttons: usar event delegation para garantir que funcionem
          document.addEventListener('click', function(ev) {
            const btn = ev.target.closest && ev.target.closest('.global-export-btn');
            if (!btn) return;
            ev.preventDefault();

            const exportUrl = btn.dataset.exportUrl;
            // tenta obter filtros existentes na página
            const start = document.getElementById('start_date') ? document.getElementById('start_date').value : '';
            const end = document.getElementById('end_date') ? document.getElementById('end_date').value : '';
            const zone = document.getElementById('zone') ? document.getElementById('zone').value : '';
            const type = document.getElementById('type') ? document.getElementById('type').value : '';
            const userId = document.getElementById('user_id') ? document.getElementById('user_id').value : '';
            const anyFilter = start || end || zone || type || userId;

            const params = new URLSearchParams();
            if (start) params.append('start_date', start);
            if (end) params.append('end_date', end);
            if (zone) params.append('zone', zone);
            if (type) params.append('type', type);
            if (userId) params.append('user_id', userId);

            const finalUrl = exportUrl + (params.toString() ? ('?' + params.toString()) : '');

            if (!anyFilter) {
              if (typeof window.openExportModal === 'function') {
                window.openExportModal(finalUrl);
              } else {
                const confirmAll = confirm('Não foram aplicados filtros. Deseja exportar todos os registos? OK = Exportar tudo, Cancel = Ir para Ocorrências para aplicar filtros.');
                if (!confirmAll) {
                  window.location.href = '{{ url_for("ocorrencias") }}';
                  return;
                }
                window.open(finalUrl, '_blank');
              }
              return;
            }

            // Se houver filtros, abre diretamente numa nova aba
            window.open(finalUrl, '_blank');
          });
        </script>
      </div>
    </div>
  </nav>
  <!-- Mobile Menu (hidden on sm+) -->
  <div id="mobileMenu" class="hidden sm:hidden bg-white border-b border-gray-200 shadow-md">
    <div class="px-4 py-3 space-y-1">
      <a href="{{ url_for('dashboard') }}" class="block text-gray-700 hover:text-primary-600 hover:bg-primary-50 px-3 py-2 rounded-md">Dashboard</a>
      <a href="{{ url_for('ocorrencias') }}" class="block text-gray-700 hover:text-primary-600 hover:bg-primary-50 px-3 py-2 rounded-md">Ocorrências</a>
      {% if current_user.role in ['presidente', 'supervisor'] %}
      <a href="{{ url_for('users') }}" class="block text-gray-700 hover:text-primary-600 hover:bg-primary-50 px-3 py-2 rounded-md">Utilizadores</a>
      {% endif %}
      <a href="{{ url_for('notifications') }}" class="block text-gray-700 hover:text-primary-600 hover:bg-primary-50 px-3 py-2 rounded-md">Notificações</a>
      <a href="{{ url_for('profile') }}" class="block text-gray-700 hover:text-primary-600 hover:bg-primary-50 px-3 py-2 rounded-md">Perfil</a>
      <a href="{{ url_for('logout') }}" class="block text-red-600 hover:text-red-700 hover:bg-red-50 px-3 py-2 rounded-md">Terminar Sessão</a>
    </div>
  </div>
  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="fixed top-4 right-4 z-50 space-y-4" id="notifications">
          {% for category, message in messages %}
            <div class="rounded-lg p-4 flex items-center space-x-4 {% if category == 'success' %}bg-green-100 text-green-700{% elif category == 'danger' %}bg-red-100 text-red-700{% else %}bg-blue-100 text-blue-700{% endif %} shadow-lg transition-all duration-500 ease-in-out transform translate-x-0"
                 role="alert">
              <div class="flex-shrink-0">
                {% if category == 'success' %}
                  <i class="fas fa-check-circle"></i>
                {% elif category == 'danger' %}
                  <i class="fas fa-exclamation-circle"></i>
                {% else %}
                  <i class="fas fa-info-circle"></i>
                {% endif %}
              </div>
              <div class="flex-1">{{ message }}</div>
              <button type="button" class="flex-shrink-0 text-current hover:opacity-75" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
              </button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Content -->
    {% block content %}{% endblock %}
  </main>

  <!-- Export modal (abre quando não há filtros aplicados) -->
  <div id="exportModal" class="fixed inset-0 z-60 opacity-0 pointer-events-none transition-opacity duration-300 flex items-center justify-center" style="display: flex;">
    <div class="absolute inset-0 bg-black bg-opacity-40"></div>
    <div class="relative bg-white rounded-lg shadow-lg w-full max-w-md mx-4">
        <div class="p-4 border-b">
          <h3 class="text-lg font-semibold">Exportar Ocorrências</h3>
          <p class="text-sm text-gray-500 mt-1">Nenhum filtro foi aplicado. Escolha uma opção:</p>
        </div>
        <div class="p-4 space-y-3">
          <button id="exportDownloadAll" class="w-full px-4 py-2 bg-primary-600 text-white rounded">Descarregar Tudo</button>
          <button id="exportAddFilters" class="w-full px-4 py-2 bg-white border border-gray-200 rounded text-gray-700">Adicionar Filtros</button>
          <button id="exportCancel" class="w-full px-4 py-2 bg-gray-100 rounded">Cancelar</button>
        </div>
      </div>
    </div>

  <script>
    // Auto-hide notifications and mobile profile/menu wiring
    document.addEventListener('DOMContentLoaded', function() {
      // Auto-hide flash notifications
      const notifications = document.querySelectorAll('#notifications > div');
      notifications.forEach(notification => {
        setTimeout(() => {
          notification.classList.add('opacity-0', 'transition', 'duration-500');
          setTimeout(() => {
            if (notification.parentElement) notification.remove();
          }, 600);
        }, 5000);
      });

      // Wire mobile profile button to open/close the mobile menu
      const mobileProfileBtn = document.getElementById('mobileProfileBtn');
      const mobileMenu = document.getElementById('mobileMenu');
      const mobileMenuBtn = document.getElementById('mobileMenuButton');
      function toggleMobileMenu() {
        if (!mobileMenu) return;
        mobileMenu.classList.toggle('hidden');
      }
      if (mobileProfileBtn) {
        mobileProfileBtn.addEventListener('click', function(ev) {
          ev.stopPropagation();
          toggleMobileMenu();
        });
      }

      // Also ensure the existing hamburger button still works (in case head script didn't run)
      if (mobileMenuBtn && !mobileMenuBtn._bound) {
        mobileMenuBtn.addEventListener('click', function(ev) {
          ev.stopPropagation();
          toggleMobileMenu();
        });
        mobileMenuBtn._bound = true;
      }

      // Close mobile menu on outside click
      document.addEventListener('click', function(ev) {
        if (!mobileMenu) return;
        const target = ev.target;
        if (!mobileMenu.classList.contains('hidden') && !mobileMenu.contains(target) && !(mobileMenuBtn && mobileMenuBtn.contains(target)) && !(mobileProfileBtn && mobileProfileBtn.contains(target))) {
          mobileMenu.classList.add('hidden');
        }
      });
    });

    // Funções para o modal de export
    (function(){
      const modal = document.getElementById('exportModal');
      const btnDownload = document.getElementById('exportDownloadAll');
      const btnFilters = document.getElementById('exportAddFilters');
      const btnCancel = document.getElementById('exportCancel');
      let _exportUrl = null;

      function openModal(url) {
        _exportUrl = url;
        if (modal) {
          modal.classList.remove('opacity-0', 'pointer-events-none');
          modal.classList.add('opacity-100');
        }
      }

      function closeModal() {
        _exportUrl = null;
        if (modal) {
          modal.classList.add('opacity-0', 'pointer-events-none');
          modal.classList.remove('opacity-100');
        }
      }

      // Expor tudo
      if (btnDownload) btnDownload.addEventListener('click', function(){
        if (_exportUrl) {
          window.open(_exportUrl, '_blank');
        }
        closeModal();
      });

      // Ir para página de ocorrências para aplicar filtros
      if (btnFilters) btnFilters.addEventListener('click', function(){
        closeModal();
        window.location.href = '{{ url_for("ocorrencias") }}';
      });

      // Cancelar
      if (btnCancel) btnCancel.addEventListener('click', function(){
        closeModal();
      });

      // Expor função global para ser usada pelo script do header
      window.openExportModal = function(url) {
        openModal(url);
      };
    })();
  </script>
</body>
</html>
